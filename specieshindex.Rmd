---
title: "Honours methods"
author: "Jess"
date: "2/21/2020"
output: html_document
---

```{r, setup}
pacman::p_load(tidyverse,
               rscopus,
               httr,
               XML,
               taxize,
               rlang,
               gtools,
               secret)
```

**Functions**
1. CountSpT
  + counts the total number of search results on Scopus
  + title only
2. CountSpTAK
  + counts the total number of search results on Scopus
  + title + abstract + keywords
3. CountSpTexp
  + counts the total number of search results of species plus a keyword
  + title
4. CountSpTAKexp
  + counts the total number of search results of species plus a keyword
  + title + abstract + keywords
5. FetchSpT
  + fetches data from Scopus using genus and species name
  + title only
6. FetchSpTAK
  + fetches data from Scopus using genus and species name
  + title + abstract + keywords
7. TotalPub
  + counts the total number of publications
8. TotalCite
  + counts the total number of citations
9. TotalJournals
  + counts the total number of journals
10. TotalArt
  + counts the total number of articles
11. TotalRev
  + counts the total number of reviews
12. ARRatio
  + calculates article:review ratio
13. SpHindex
  + calculates h-index
14. YearsPublishing
  + calculates the number of years since the first publication
15. SpMindex
  + calculates m-index (h-index / total years)
16. Spi10
  + counts the publications with 10+ citations
17. SpH5
  + calculates h-index for the past 5 years
18. SpHAfterdate
  + calculates h-index with a given time frame
19. Allindices
  + shows a summary of the main indices




```{r, function to get result count title only, message=FALSE}
#code from Fonti (modified)
CountSpT <- function(genus, species, APIkey, datatype = "application/xml") {
  library(httr)
  library(XML)
  library(rlang)
  library(taxize)
  library(dplyr)
    if (missing(APIkey)) {
    stop("You need to register for an API key on Scopus.") #stop running if API key missing
  }
  findname <- gnr_resolve(names = c(genus, species)) #check if the species exist
  case_when(
    findname$submitted_name %in% findname$matched_name ~ print(paste("Species found on the Encyclopedia of Life."))
  )
  theURL <- GET("http://api.elsevier.com/content/search/scopus",
              query = list(apiKey = paste0(APIkey),
                           query = paste0('TITLE("', genus, ' ', species, '")'),
                           httpAccept = "application/xml")) #format the URL to be sent to the API
  stop_for_status(theURL) #pass any HTTP errors to the R console
  theData <- content(theURL, as = "text") #extract the content of the response
  newData <- xmlParse(theURL) #parse the data to extract values
  resultCount <- as.numeric(xpathSApply(newData,"//opensearch:totalResults", xmlValue)) #get the total number of search results for the string
  return(resultCount)
}
```

```{r, function to get result count title+abs+key, message=FALSE}
#code from Fonti (modified)
CountSpTAK <- function(genus, species, APIkey, datatype = "application/xml") {
  library(httr)
  library(XML)
  library(rlang)
  library(taxize)
  library(dplyr)
    if (missing(APIkey)) {
    stop("You need to register for an API key on Scopus.") #stop running if API key missing
   }
  findname <- gnr_resolve(names = c(genus, species)) #check if the species exist
  case_when(
    findname$submitted_name %in% findname$matched_name ~ print(paste("Species found on the Encyclopedia of Life."))
  )
   theURL <- GET("http://api.elsevier.com/content/search/scopus",
              query = list(apiKey = paste0(APIkey),
                           query = paste0('TITLE-ABS-KEY("', genus, ' ', species, '")'),
                           httpAccept = "application/xml")) #format the URL to be sent to the API
  stop_for_status(theURL) #pass any HTTP errors to the R console
  theData <- content(theURL, as = "text") #extract the content of the response
  newData <- xmlParse(theURL) #parse the data to extract values
  resultCount <- as.numeric(xpathSApply(newData,"//opensearch:totalResults", xmlValue)) #get the total number of search results for the string
  return(resultCount)
}
```

```{r, message=FALSE}
CountSpTexp <- function(genus, species, additionalkeywords, APIkey, datatype = "application/xml") {
  library(httr)
  library(XML)
  library(rlang)
  library(taxize)
  library(dplyr)
    if (missing(APIkey)) {
    stop("You need to register for an API key on Scopus.") #stop running if API key missing
   }
  findname <- gnr_resolve(names = c(genus, species)) #check if the species exist
  case_when(
    findname$submitted_name %in% findname$matched_name ~ print(paste("Species found on the Encyclopedia of Life."))
  ) 
   theURL <- GET("http://api.elsevier.com/content/search/scopus",
              query = list(apiKey = paste0(APIkey),
                           query = paste0('TITLE("', genus, ' ', species, '"', ' AND ', additionalkeywords, ')'),
                           httpAccept = "application/xml")) #format the URL to be sent to the API
  stop_for_status(theURL) #pass any HTTP errors to the R console
  theData <- content(theURL, as = "text") #extract the content of the response
  newData <- xmlParse(theURL) #parse the data to extract values
  resultCount <- as.numeric(xpathSApply(newData,"//opensearch:totalResults", xmlValue)) #get the total number of search results for the string
  return(resultCount)
}
```

```{r, message=FALSE}
CountSpTAKexp <- function(genus, species, additionalkeywords, APIkey, datatype = "application/xml") {
  library(httr)
  library(XML)
  library(rlang)
  library(taxize)
  library(dplyr)
    if (missing(APIkey)) {
    stop("You need to register for an API key on Scopus.") #stop running if API key missing
   }
  findname <- gnr_resolve(names = c(genus, species)) #check if the species exist
  case_when(
    findname$submitted_name %in% findname$matched_name ~ print(paste("Species found on the Encyclopedia of Life."))
  ) 
   theURL <- GET("http://api.elsevier.com/content/search/scopus",
              query = list(apiKey = paste0(APIkey),
                           query = paste0('TITLE-ABS-KEY("', genus, ' ', species, '"', ' AND ', additionalkeywords, ')'),
                           httpAccept = "application/xml")) #format the URL to be sent to the API
  stop_for_status(theURL) #pass any HTTP errors to the R console
  theData <- content(theURL, as = "text") #extract the content of the response
  newData <- xmlParse(theURL) #parse the data to extract values
  resultCount <- as.numeric(xpathSApply(newData,"//opensearch:totalResults", xmlValue)) #get the total number of search results for the string
  return(resultCount)
}
```

```{r, fetch using title only, message=FALSE}
#this function downloads citation data from scopus
FetchSpT <- function(genus, species, APIkey) {
  library(rscopus)
  library(rlang)
  library(dplyr)
  count <- CountSpT(genus, species, APIkey) #check the number of records
  print(paste(count, "records found."))
  if (count < 1) {
    noCitations <- data.frame(citations = 0)
    return(noCitations)
  }
  #loop if count is under 5000
  if (count <= 5000) {
    step_size <- 1000 #the number of records to retrieve in each loop
  start_record <- 0
  datalist = data.frame()
  looprepeat <- ceiling(count/step_size)-1 #the number of loop times, rounded up to the nearest integer
  #loop starts
  for (i in 0:looprepeat) { 
    print(paste("starting iteration: ", i, " Note: iteration size is ", step_size, " records, which runs of 200 records inside each iteration."))
    print(paste("Fetching records now."))
    search <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\")"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          max_count = step_size,
                          start = step_size*i,
                          wait_time = 3)
    start_record <- as.numeric(summary(search)[1,1]) #move the pointer of starting record for each iteration to a new value
    searchdf <- entries_to_citation_df(search$entries)
    list <- data.frame(searchdf)
    datalist <- rbind(datalist, list)
    #loop ends
  }} else {
  #search begins
  search1 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR > 2018"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)
  search1df <- entries_to_citation_df(search1$entries)
  search2 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR = 2018"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)
  search2df <- entries_to_citation_df(search2$entries)
  search3 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR = 2017"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search3df <- entries_to_citation_df(search3$entries)
  search4 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR = 2016"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search4df <- entries_to_citation_df(search4$entries)
  search5 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR = 2015"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search5df <- entries_to_citation_df(search5$entries)
  search6 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR = 2014"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search6df <- entries_to_citation_df(search6$entries)
  search7 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR = 2013"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search7df <- entries_to_citation_df(search7$entries)
  search8 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR = 2012"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search8df <- entries_to_citation_df(search8$entries)
  search9 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR = 2011"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search9df <- entries_to_citation_df(search9$entries)
  search10 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR = 2010"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search10df <- entries_to_citation_df(search10$entries)
  search11 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR = 2009"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search11df <- entries_to_citation_df(search11$entries)
  search12 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR > 2006 AND PUBYEAR < 2009"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search12df <- entries_to_citation_df(search12$entries)
  search13 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR > 2004 AND PUBYEAR < 2007"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search13df <- entries_to_citation_df(search13$entries)
  search14 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR > 2002 AND PUBYEAR < 2005"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search14df <- entries_to_citation_df(search14$entries)
  search15 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR > 2000 AND PUBYEAR < 2003"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search15df <- entries_to_citation_df(search15$entries)
  search16 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR > 1998 AND PUBYEAR < 2001"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search16df <- entries_to_citation_df(search16$entries)
  search17 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR > 1996 AND PUBYEAR < 1999"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search17df <- entries_to_citation_df(search17$entries)
  search18 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR > 1994 AND PUBYEAR < 1997"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search18df <- entries_to_citation_df(search18$entries)
  search19 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR > 1992 AND PUBYEAR < 1995"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search19df <- entries_to_citation_df(search19$entries)
  search20 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR > 1990 AND PUBYEAR < 1993"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search20df <- entries_to_citation_df(search20$entries)
  search21 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR > 1985 AND PUBYEAR < 1991"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search21df <- entries_to_citation_df(search21$entries)
  search22 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR > 1980 AND PUBYEAR < 1986"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search22df <- entries_to_citation_df(search22$entries)
  search23 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR > 1975 AND PUBYEAR < 1981"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search23df <- entries_to_citation_df(search23$entries)
  search24 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR > 1970 AND PUBYEAR < 1976"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search24df <- entries_to_citation_df(search24$entries)
  search25 <- scopus_search(query = paste0("TITLE(\"",genus," ",species,"\") AND PUBYEAR < 1971"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search25df <- entries_to_citation_df(search25$entries)
  datalist <- rbind(search1df, search2df, search3df, search4df, search5df, search6df, search7df, search8df, search9df, search10df, search11df, search12df, search13df, search14df, search15df, search16df, search17df, search18df, search19df, search20df, search21df, search22df, search23df, search24df, search25df)
  #search ends  
  }
  returned <- dim(datalist)[1]
  print(paste(returned, "records retrived in total."))
  #if else here
  duplicates <- dim(datalist[duplicated(datalist$title),])[1] #check for duplicates
  print(paste(duplicates, "duplicates found."))
  if (duplicates>0) { #remove duplicates if they are present
    print(paste("Removing duplicated records."))
    datalist <- datalist[!duplicated(datalist$title), ] 
  }
  #showing final list of records
  retrieved <- dim(datalist)[1] #check the number
  print(paste(retrieved, "unique records successfully fetched."))
  return(datalist)
}
```

```{r, fetch using title+abs+key, message=FALSE}
#this function downloads citation data from scopus
FetchSpTAK <- function(genus, species, APIkey) {
  library(rscopus)
  library(rlang)
  library(dplyr)
  count <- CountSpTAK(genus, species, APIkey) #check the number of records
  print(paste(count, "records found."))
  if (count < 1) {
    noCitations <- data.frame(citations = 0)
    return(noCitations)
  }
  #loop if count is under 5000
  if (count <= 5000) {
    step_size <- 1000 #the number of records to retrieve in each loop
  start_record <- 0
  datalist = data.frame()
  looprepeat <- ceiling(count/step_size)-1 #the number of loop times, rounded up to the nearest integer
  #loop starts
  for (i in 0:looprepeat) { 
    print(paste("starting iteration: ", i, " Note: iteration size is ", step_size, " records, which runs of 200 records inside each iteration."))
    print(paste("Fetching records now."))
    search <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\")"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          max_count = step_size,
                          start = step_size*i,
                          wait_time = 3)
    start_record <- as.numeric(summary(search)[1,1]) #move the pointer of starting record for each iteration to a new value
    searchdf <- entries_to_citation_df(search$entries)
    list <- data.frame(searchdf)
    datalist <- rbind(datalist, list)
    #loop ends
  }} else {
  #search begins
  search1 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR > 2018"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)
  search1df <- entries_to_citation_df(search1$entries)
  search2 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR = 2018"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)
  search2df <- entries_to_citation_df(search2$entries)
  search3 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR = 2017"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search3df <- entries_to_citation_df(search3$entries)
  search4 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR = 2016"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search4df <- entries_to_citation_df(search4$entries)
  search5 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR = 2015"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search5df <- entries_to_citation_df(search5$entries)
  search6 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR = 2014"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search6df <- entries_to_citation_df(search6$entries)
  search7 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR = 2013"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search7df <- entries_to_citation_df(search7$entries)
  search8 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR = 2012"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search8df <- entries_to_citation_df(search8$entries)
  search9 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR = 2011"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search9df <- entries_to_citation_df(search9$entries)
  search10 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR = 2010"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search10df <- entries_to_citation_df(search10$entries)
  search11 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR = 2009"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search11df <- entries_to_citation_df(search11$entries)
  search12 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR > 2006 AND PUBYEAR < 2009"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search12df <- entries_to_citation_df(search12$entries)
  search13 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR > 2004 AND PUBYEAR < 2007"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search13df <- entries_to_citation_df(search13$entries)
  search14 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR > 2002 AND PUBYEAR < 2005"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search14df <- entries_to_citation_df(search14$entries)
  search15 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR > 2000 AND PUBYEAR < 2003"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search15df <- entries_to_citation_df(search15$entries)
  search16 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR > 1998 AND PUBYEAR < 2001"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search16df <- entries_to_citation_df(search16$entries)
  search17 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR > 1996 AND PUBYEAR < 1999"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search17df <- entries_to_citation_df(search17$entries)
  search18 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR > 1994 AND PUBYEAR < 1997"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search18df <- entries_to_citation_df(search18$entries)
  search19 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR > 1992 AND PUBYEAR < 1995"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search19df <- entries_to_citation_df(search19$entries)
  search20 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR > 1990 AND PUBYEAR < 1993"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search20df <- entries_to_citation_df(search20$entries)
  search21 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR > 1985 AND PUBYEAR < 1991"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search21df <- entries_to_citation_df(search21$entries)
  search22 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR > 1980 AND PUBYEAR < 1986"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search22df <- entries_to_citation_df(search22$entries)
  search23 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR > 1975 AND PUBYEAR < 1981"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search23df <- entries_to_citation_df(search23$entries)
  search24 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR > 1970 AND PUBYEAR < 1976"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search24df <- entries_to_citation_df(search24$entries)
  search25 <- scopus_search(query = paste0("TITLE-ABS-KEY(\"",genus," ",species,"\") AND PUBYEAR < 1971"),
                          api_key = paste0(APIkey),
                          verbose = TRUE,
                          wait_time = 3)  
  search25df <- entries_to_citation_df(search25$entries)
  datalist <- rbind(search1df, search2df, search3df, search4df, search5df, search6df, search7df, search8df, search9df, search10df, search11df, search12df, search13df, search14df, search15df, search16df, search17df, search18df, search19df, search20df, search21df, search22df, search23df, search24df, search25df)
  #search ends  
  }
  returned <- dim(datalist)[1]
  print(paste(returned, "records retrived in total."))
  #if else here
  duplicates <- dim(datalist[duplicated(datalist$title),])[1] #check for duplicates
  print(paste(duplicates, "duplicates found."))
  if (duplicates>0) { #remove duplicates if they are present
    print(paste("Removing duplicated records."))
    datalist <- datalist[!duplicated(datalist$title), ] 
  }
  #showing final list of records
  retrieved <- dim(datalist)[1] #check the number
  print(paste(retrieved, "unique records successfully fetched."))
  return(datalist)
}
```

```{r, total publications}
#this function calculates the total number of publications
TotalPub <- function(data) {
  total <- nrow(data) #counts the number of publications by summing the records
  return(total)
}
```

```{r, total citations}
#this function calculates the total number of citations
TotalCite <- function(data) {
  data$citations <- as.numeric(data$citations) #changes the class to numerical for calculation
  total <- sum(data$citations) #sums all of the citations
  return(total)
}
```

```{r, total journals}
#this function calculates the total number of journals
TotalJournals <- function(data) {
  filter <- unique(data$journal) #filters data to pick out each journal
  total <- length(filter) #counts the number of journals
  return(total)
}
```

```{r, total articles}
#this function calculates the total number of articles
TotalArt <- function(data) {
  Article <- sum(data$description == "Article") #calculates the number of articles
  return(Article)
}
```

```{r, total reviews}
#this function calculates the total number of reviews
TotalRev <- function(data) {
  Review <- sum(data$description == "Review") #calculates the number of reviews
  return(Review)
}
```

```{r, article:review ratio}
#this function calculates the ratio of articles:rerviews
ARRatio <- function(data) {
  Article <- sum(data$description == "Article") #calculates the number of articles
  Review <- sum(data$description == "Review") #calculates the number of reviews
  ArticleRatio <- signif(Article/(Article+Review)*100, digits = 4) #percentage of articles, rounded to 4 sf
  ReviewRatio <- signif(Review/(Article+Review)*100, digits = 4) #percentage of reviews, rounded to 4 sf
  Ratio <- paste(ArticleRatio, ":", ReviewRatio) #prints ratio
  return(Ratio)
}
```

```{r, species h-index}
#this function calculates the h-index
SpHindex <- function(data) {
  data$citations <- as.numeric(data$citations) #change class from factor to numeric
  sorteddf <- sort(data$citations, decreasing = TRUE) #sort in descending order
  Hindex <- 0   #computes h-index
  for(i in 1:length(sorteddf)) {
    if (sorteddf[i] > Hindex) {
      Hindex <- Hindex + 1
    }
  }
  return(Hindex)
}
```

```{r, years of publication}
#this function canculates the number of years since the first publication
YearsPublishing <- function(data) {
  data$year <- as.numeric(substr(data$cover_date, 1, 4))
  as.numeric(substr(Sys.Date(), 1, 4)) - min(data$year) #time since first publication in years
  years_publishing <- as.numeric(substr(Sys.Date(), 1, 4)) - min(data$year) #time since first publication in years
  return(years_publishing)
}
```

```{r, m-index}
#this function calculates the m-index
#it does not requires the calculation of the h-index beforehand
SpMindex <- function(data) {
  data$citations <- as.numeric(data$citations) #change class from factor to numeric
  sorteddf <- sort(data$citations, decreasing = TRUE) #sort in descending order
  Hindex <- 0   #computes h-index
  for(i in 1:length(sorteddf)) {
    if (sorteddf[i] > Hindex) {
      Hindex <- Hindex + 1
    }
  }
  data$year <- as.numeric(substr(data$cover_date, 1, 4))
  years_publishing <- as.numeric(substr(Sys.Date(), 1, 4)) - min(data$year) #time since first publication in years
  Mindex <- round(Hindex/years_publishing, digits = 3) #round to 3 decimal places
  return(Mindex)
}
```

```{r, i10 index}
#this function calculates the i10 index
#i10 index counts all of the publications with 10+ citations
Spi10 <- function(data) {
  data$citations <- as.numeric(data$citations) #changes class from factor to numeric
  sorteddf <- sort(data$citations, decreasing = TRUE) #sorts in descending order
  i10 <- sum(sorteddf>=10) #counts the publications with 10 or more citations
  return(i10)
}
```

```{r, h5 index}
#this function calculates the h-index of the past 5 years
SpH5 <- function(data) { #last 5 years from the current date
  current_date <- as.numeric(substr(Sys.Date(), 1, 4)) #current year
  #The easiest thing to do is to convert it into POSIXlt and subtract 5 from the years slot.
  d <- as.POSIXlt(Sys.Date())
  d$year <- d$year-5
  if (d < 1) { #the index is 0 if there are no records form the past 5 years
    return(as.numeric("0"))
  }
  as.Date(d)
  h5 <- SpHAfterdate(data, d)
  return(h5) #calls HAfterdate function
}
```

```{r, h-index with a given date}
#this function calculates the h-index using a given date up till the newest record
SpHAfterdate <- function(data, date) {
  library(dplyr)
  data$cover_date <- as.Date(data$cover_date, format = "%Y-%m-%d") #change format of the date from factor to date
  subsetdata <- filter(data, cover_date > as.Date(date))
  if (count(subsetdata) < 1) { #the index is 0 if there are no records in this time frame
    return(as.numeric("0"))
  }
  HAfterdate <- SpHindex(subsetdata) #calls Hindex function
  return(HAfterdate)
}
```

```{r, shows main indices}
#this function returns a summary of all of the indices
Allindices <- function(data, genus, species) {
  combine <- data.frame(paste0(genus, "_", species), paste0(species), paste0(genus), TotalPub(data), TotalCite(data),
                        TotalJournals(data),TotalArt(data),TotalRev(data), YearsPublishing(data),
                        SpHindex(data), SpMindex(data), Spi10(data), SpH5(data))
    combine[is.na(combine)] <- 0 #replace NA values with 0
    colnames(combine) <- c("genus_species", "species", "genus","publications", "citations", "journals", "articles",
                         "reviews", "years_publishing", "h", "m", "i10",
                         "h5")
    return(combine)
  if (data$citations == 0) {
    zeroIndex <- data.frame(genus_species = paste0(genus, "_", species),
                            species = paste0(species),
                            genus = paste0(genus),
                            publications = 0, citations = 0, journals = 0, articles = 0, reviews = 0, years_publishing = NA,
                            h = 0, m = 0, i10 = 0, h5 = 0)
    return(zeroIndex)
  }
  cat("\n", genus, species, "\n",
      TotalPub(data), "publications", "\n",
      TotalCite(data), "citations", "\n",
      TotalJournals(data), "journals", "\n",
      TotalArt(data), "articles", "\n",
      TotalRev(data), "reviews", "\n",
      YearsPublishing(data), "years of publishing", "\n",
      "h:", SpHindex(data), "\n",
      "m:", SpMindex(data), "\n",
      "i10:", Spi10(data), "\n",
      "h5:", SpH5(data))
}
```


**Tests**

```{r}
vault <- file.path("C:/Users/iamje/Jess/UNSW/BEES0006/specieshindex", ".vault")
key_dir <- file.path(system.file(package = "secret"), "user_keys")
public_key <- file.path(key_dir, "jesst.pub")
private_key <- file.path(key_dir, "jesst.pem")
myAPI <- get_secret("myAPI", key = private_key, vault = vault) #loading my hidden API key
```

```{r, woylie}
#test done on 10 july
CountSpT("Bettongia", "penicillata", myAPI) #45
CountSpTAK("Bettongia", "penicillata", myAPI) #113
FetchSpTAK("Bettongia", "penicillata", myAPI) #no duplicates

TotalPub(Woylie) #113
TotalCite(Woylie) #1897
TotalJournals(Woylie) #55
TotalArt(Woylie) #110
TotalRev(Woylie) #3
ARRatio(Woylie) #97.35 : 2.655

YearsPublishing(Woylie) #43
SpHindex(Woylie) #26
SpMindex(Woylie) #0.6046512
Spi10(Woylie) #54
SpH5(Woylie) #8
SpHAfterdate(Woylie, "2000-01-01") #20
SpHYear(Woylie)
SpHGrowth(Woylie)

B_penicillata <- Allindices(Woylie, genus = "Bettongia", species = "penicillata")
```

```{r, quokka}
#test done on 10 july
CountSpTAK("Setonix", "brachyurus", myAPI) #242
Quokka <- FetchSpTAK("Setonix", "brachyurus", myAPI) #no duplicates

TotalPub(Quokka) #242
TotalCite(Quokka) #3423
TotalJournals(Quokka) #107
TotalArt(Quokka) #237
TotalRev(Quokka) #5
ARRatio(Quokka) #97.93 : 2.066

YearsPublishing(Quokka) #66
SpHindex(Quokka) #29
SpMindex(Quokka) #0.4393939
Spi10(Quokka) #121
SpH5(Quokka) #3
SpHAfterdate(Quokka, "2000-01-01") #17
SpHYear(Quokka)
SpHGrowth(Quokka)

S_brachyurus <- Allindices(Quokka, genus = "Setonix", species = "brachyurus")
```

```{r, platypus}
#test done on 10 july
CountSpTAK #321
Platypus <- FetchSpTAK("Ornithorhynchus", "anatinus", myAPI) #no duplicates

TotalPub(Platypus) #321
TotalCite(Platypus) #6363
TotalJournals(Platypus) #153
TotalArt(Platypus) #308
TotalRev(Platypus) #13
ARRatio(Platypus) #95.95 : 4.05

YearsPublishing(Platypus) #67
SpHindex(Platypus) #41
SpMindex(Platypus) #0.6119403
Spi10(Platypus) #177
SpH5(Platypus) #7
SpHAfterdate(Platypus, "2000-01-01") #32
SpHYear(Platypus)
SpHGrowth(Platypus)

O_anatinus <- Allindices(Platypus, genus = "Ornithorhynchus", species = "anatinus")
```

```{r, koala}
#test done on 10 july
CountSpTAK("Phascolarctos", "cinereus", myAPI) #777
FetchSpTAK("Phascolarctos", "cinereus", myAPI) #4 duplicates
CountSpTAKexp("Phascolarctos", "cinereus", additionalkeywords = "(consrv* OR protect* OR reintrod* OR restor*)", "442b9048417ef20cf680a0ae26ee4d86") #70
CountSpTAKexp("Phascolarctos", "cinereus", additionalkeywords = "(popul* W/5 ecolog*)", "442b9048417ef20cf680a0ae26ee4d86") #11
CountSpTAKexp("Phascolarctos", "cinereus", additionalkeywords = "(breed* OR reprod* OR fertil* OR fecund*)", "442b9048417ef20cf680a0ae26ee4d86") #143
CountSpTAKexp("Phascolarctos", "cinereus", additionalkeywords = "(popul* AND NOT popular)", "442b9048417ef20cf680a0ae26ee4d86") #322
CountSpTAKexp("Phascolarctos", "cinereus", additionalkeywords = "NOT (phylog* OR taxonom*)", "442b9048417ef20cf680a0ae26ee4d86") #758
CountSpTAKexp(genus = "Phascolarctos", species = "cinereus", APIkey = "442b9048417ef20cf680a0ae26ee4d86") #no additional search terms; error

TotalPub(Koala) #773
TotalCite(Koala) #14291
TotalJournals(Koala) #227
TotalArt(Koala) #744
TotalRev(Koala) #29
ARRatio(Koala) #96.25 : 3.752

YearsPublishing(Koala) #139
SpHindex(Koala) #53
SpMindex(Koala) #0.381295
Spi10(Koala) #427
SpH5(Koala) #15
SpHAfterdate(Koala, "2000-01-01") #44
SpHYear(Koala)
SpHGrowth(Koala)

P_cinereus <- Allindices(Koala, genus = "Phascolarctos", species = "cinereus")
```

```{r, combining the datasets}
Combinedata <- rbind(B_penicillata, S_brachyurus, O_anatinus, P_cinereus)

plot(Combinedata$publications)
plot(Combinedata$citations)
plot(Combinedata$journals)
plot(Combinedata$articles)
plot(Combinedata$reviews)
plot(Combinedata$years_publishing)
plot(Combinedata$h)
plot(Combinedata$m) #this is quite interesting
plot(Combinedata$i10)
plot(Combinedata$h5) #woylie has a pretty high index here
```

```{r, manual tests}
#test with dummy data
dummy1 <- data.frame("citations" = c(12, 5, 0, 21, 3, 4, 9, 17, 1, 10,
                                     10, 1, 0, 16, 26, 24, 15, 34, 31, 29),
                     "cover_date" = c(2000, 2015, 1986, 1994, 1972, 2002, 2006, 2019, 2016, 2006,
                                      1997, 1989, 2007, 2010, 2013, 2020, 2017, 1994, 1999, 2016))
SpHindex(dummy1) #10
YearsPublishing(dummy1) #48
SpMindex(dummy1) #0.2083333
Spi10(dummy1) #12

```



```{r, rscopus}
myAPI <- secret::get_secret("myAPI", key = private_key, vault = vault) #loading my hidden API key

#some tests

test <- scopus_search(query = "TITLE-ABS-KEY(\"pan troglodytes\") AND PUBYEAR AFT 2010",
                          api_key = myAPI,
                          verbose = TRUE,
                          wait_time = 3)
test2 <- scopus_search(query = "TITLE-ABS-KEY(\"pan troglodytes\") AND PUBYEAR BEF 2010 AND PUBYEAR AFT 2000",
                          api_key = myAPI,
                          verbose = TRUE,
                          wait_time = 3)
testdf <- entries_to_citation_df(test$entries)

tiger <- FetchSpT("Panthera", "tigris", myAPI) #402 results
CountSpTAK("Panthera", "tigris", myAPI)

dim(tiger[duplicated(tiger$title),])[1]

tiger <- FetchSpF("Panthera", "tigris", myAPI) #1823 results
fox <- FetchSpT("Vulpes", "vulpes", myAPI) #1133 results

foxT <- FetchSpT("Vulpes", "vulpes", myAPI) #1176
foxTAK <- FetchSpTAK("Vulpes", "vulpes", myAPI) #1176
drosophila <- FetchSpTAK("Drosophila", "montana", myAPI) #93 results
drosophila2 <- FetchSpF("drosophila", "melanogaster", myAPI) #65140 results
drosophila3 <- FetchSpTAK("Mus", "musculus", myAPI) 

cat <- FetchSpY("felis", "catus", myAPI) #17622 results, error at 26%, current loop can only output 2000 records
gnr_resolve(names = c("felis", "catus"))

chimpsTAK <- FetchSpTAK("pan", "troglodytes", myAPI) #10837
chimpsT <- FetchSpT("pan", "troglodytes", myAPI) #1439
chimpsY <- FetchSpY("pan", "troglodytes", myAPI) #10844 results
gnr_resolve(names = c("pan", "troglodytes"))

elephant <- FetchSpTAK("Loxodonta","africana", myAPI) #1401 results
dim(elephant[duplicated(elephant$title),])[1]

possum <- FetchSpT("Burramys", "parvus", myAPI) #47
possum <- FetchSpTAK("Burramys", "parvus", myAPI) #45
CountSpT("Burramys", "parvus", myAPI)

dim(possum[duplicated(possum$title),])[1]

mouse <- FetchSpY("Mus", "musculus", myAPI) #36197 records downloaded

gnr_resolve(names = c("felis catus"))

Pub <- TotalPub(tiger) #402
Cite <- TotalCite(tiger) #5244
Journal <- TotalJournals(tiger) #168
Article <- TotalArt(tiger)
Review <- TotalRev(tiger)
Ratio <- ARRatio(tiger) #97.5124378109453 : 2.48756218905473
class(Article)

H <- SpHindex(tiger) #53
years <- YearsPublishing(tiger) #139
M <- SpMindex(tiger) #0.381294964028777
i10 <- Spi10(tiger) #467
h5 <- SpH5(tiger) #15
datexdf <- HAfterdate(xdf, "2000-01-01") #47
ALL <- Allindices(tiger)

```

